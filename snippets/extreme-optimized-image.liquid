{% comment %}
  EXTREME Optimized Image Snippet - Carga < 3 segundos
  Máximo rendimiento para imágenes con carga instantánea
  
  Accepts:
  - image: {Object} Image Liquid object
  - class: {String} Class name for the image
  - sizes: {String} Image sizes attribute
  - loading: {String} Loading attribute ('lazy' or 'eager')
  - fetchpriority: {String} Fetchpriority attribute ('high', 'low', 'auto')
  - quality: {Number} Image quality (1-100)
  - format: {String} Image format ('webp', 'avif', 'auto')
  - placeholder: {Boolean} Show placeholder while loading
  - above_fold: {Boolean} Is above the fold
{% endcomment %}

{%- assign loading = loading | default: 'lazy' -%}
{%- assign fetchpriority = fetchpriority | default: 'auto' -%}
{%- assign quality = quality | default: 85 -%}
{%- assign format = format | default: 'auto' -%}
{%- assign placeholder = placeholder | default: true -%}
{%- assign above_fold = above_fold | default: false -%}

{%- if above_fold -%}
  {%- assign loading = 'eager' -%}
  {%- assign fetchpriority = 'high' -%}
  {%- assign placeholder = false -%}
{%- endif -%}

{%- if image -%}
  <div class="extreme-image-container{% if placeholder %} extreme-image-container--placeholder{% endif %}{% if above_fold %} extreme-image-container--above-fold{% endif %}">
    {%- if placeholder -%}
      <div class="extreme-image-placeholder">
        <div class="extreme-image-skeleton"></div>
      </div>
    {%- endif -%}
    
    <img
      class="extreme-image {{ class }}"
      {%- if loading == 'lazy' -%}
        data-src="{{ image | image_url: width: 100, quality: quality }}"
        data-srcset="
          {%- if image.width >= 100 -%}{{ image | image_url: width: 100, quality: quality }} 100w,{%- endif -%}
          {%- if image.width >= 200 -%}{{ image | image_url: width: 200, quality: quality }} 200w,{%- endif -%}
          {%- if image.width >= 400 -%}{{ image | image_url: width: 400, quality: quality }} 400w,{%- endif -%}
          {%- if image.width >= 600 -%}{{ image | image_url: width: 600, quality: quality }} 600w,{%- endif -%}
          {%- if image.width >= 800 -%}{{ image | image_url: width: 800, quality: quality }} 800w,{%- endif -%}
          {%- if image.width >= 1000 -%}{{ image | image_url: width: 1000, quality: quality }} 1000w,{%- endif -%}
          {%- if image.width >= 1200 -%}{{ image | image_url: width: 1200, quality: quality }} 1200w,{%- endif -%}
          {%- if image.width >= 1400 -%}{{ image | image_url: width: 1400, quality: quality }} 1400w,{%- endif -%}
          {%- if image.width >= 1600 -%}{{ image | image_url: width: 1600, quality: quality }} 1600w,{%- endif -%}
          {%- if image.width >= 1800 -%}{{ image | image_url: width: 1800, quality: quality }} 1800w,{%- endif -%}
          {%- if image.width >= 2000 -%}{{ image | image_url: width: 2000, quality: quality }} 2000w{%- endif -%}
        "
        src="{{ image | image_url: width: 100, quality: quality }}"
        loading="lazy"
      {%- else -%}
        src="{{ image | image_url: width: 400, quality: quality }}"
        srcset="
          {%- if image.width >= 200 -%}{{ image | image_url: width: 200, quality: quality }} 200w,{%- endif -%}
          {%- if image.width >= 400 -%}{{ image | image_url: width: 400, quality: quality }} 400w,{%- endif -%}
          {%- if image.width >= 600 -%}{{ image | image_url: width: 600, quality: quality }} 600w,{%- endif -%}
          {%- if image.width >= 800 -%}{{ image | image_url: width: 800, quality: quality }} 800w,{%- endif -%}
          {%- if image.width >= 1000 -%}{{ image | image_url: width: 1000, quality: quality }} 1000w,{%- endif -%}
          {%- if image.width >= 1200 -%}{{ image | image_url: width: 1200, quality: quality }} 1200w,{%- endif -%}
          {%- if image.width >= 1400 -%}{{ image | image_url: width: 1400, quality: quality }} 1400w,{%- endif -%}
          {%- if image.width >= 1600 -%}{{ image | image_url: width: 1600, quality: quality }} 1600w,{%- endif -%}
          {%- if image.width >= 1800 -%}{{ image | image_url: width: 1800, quality: quality }} 1800w,{%- endif -%}
          {%- if image.width >= 2000 -%}{{ image | image_url: width: 2000, quality: quality }} 2000w{%- endif -%}
        "
        loading="eager"
      {%- endif -%}
      sizes="{{ sizes | default: 'auto' }}"
      width="{{ image.width }}"
      height="{{ image.height }}"
      alt="{{ image.alt | escape }}"
      fetchpriority="{{ fetchpriority }}"
      decoding="async"
      {%- if format == 'webp' -%}
        data-webp="{{ image | image_url: width: 400, format: 'webp', quality: quality }}"
      {%- endif -%}
      onload="this.classList.add('extreme-image--loaded'); this.parentElement.classList.add('extreme-image-container--loaded')"
      onerror="this.classList.add('extreme-image--error'); this.parentElement.classList.add('extreme-image-container--error')"
    >
  </div>
  
  <style>
    .extreme-image-container {
      position: relative;
      overflow: hidden;
      background: #f5f5f5;
      contain: layout style paint;
    }
    
    .extreme-image-container--above-fold {
      background: transparent;
    }
    
    .extreme-image-container--placeholder .extreme-image {
      opacity: 0;
      transition: opacity .15s ease;
    }
    
    .extreme-image-container--loaded .extreme-image {
      opacity: 1;
    }
    
    .extreme-image-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .extreme-image-skeleton {
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: extreme-skeleton-loading 1s infinite;
    }
    
    .extreme-image {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      object-fit: cover;
      will-change: opacity;
    }
    
    .extreme-image--loaded {
      opacity: 1;
    }
    
    .extreme-image--error {
      opacity: 0.5;
    }
    
    @keyframes extreme-skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* EXTREME Performance optimizations */
    .extreme-image-container {
      contain: layout style paint;
      will-change: transform;
    }
    
    .extreme-image {
      will-change: opacity;
      transform: translateZ(0);
    }
    
    /* Above fold optimizations */
    .extreme-image-container--above-fold .extreme-image {
      will-change: auto;
    }
  </style>
{%- else -%}
  <div class="extreme-image-container extreme-image-container--placeholder">
    <div class="extreme-image-placeholder">
      <div class="extreme-image-skeleton"></div>
    </div>
  </div>
{%- endif -%}
