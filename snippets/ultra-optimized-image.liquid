{% comment %}
  Ultra Optimized Image Snippet
  Maximum performance image rendering with advanced optimizations
  
  Accepts:
  - image: {Object} Image Liquid object
  - class: {String} Class name for the image
  - sizes: {String} Image sizes attribute
  - widths: {String} Image widths attribute
  - loading: {String} Loading attribute ('lazy' or 'eager')
  - fetchpriority: {String} Fetchpriority attribute ('high', 'low', 'auto')
  - quality: {Number} Image quality (1-100)
  - format: {String} Image format ('webp', 'avif', 'auto')
  - placeholder: {Boolean} Show placeholder while loading
{% endcomment %}

{%- assign loading = loading | default: 'lazy' -%}
{%- assign fetchpriority = fetchpriority | default: 'auto' -%}
{%- assign quality = quality | default: 80 -%}
{%- assign format = format | default: 'auto' -%}
{%- assign placeholder = placeholder | default: true -%}

{%- if image -%}
  <div class="ultra-image-container{% if placeholder %} ultra-image-container--placeholder{% endif %}">
    {%- if placeholder -%}
      <div class="ultra-image-placeholder">
        <div class="ultra-image-skeleton"></div>
      </div>
    {%- endif -%}
    
    <img
      class="ultra-image {{ class }}"
      {%- if loading == 'lazy' -%}
        data-src="{{ image | image_url: width: 100, quality: quality }}"
        data-srcset="
          {%- if image.width >= 100 -%}{{ image | image_url: width: 100, quality: quality }} 100w,{%- endif -%}
          {%- if image.width >= 200 -%}{{ image | image_url: width: 200, quality: quality }} 200w,{%- endif -%}
          {%- if image.width >= 400 -%}{{ image | image_url: width: 400, quality: quality }} 400w,{%- endif -%}
          {%- if image.width >= 600 -%}{{ image | image_url: width: 600, quality: quality }} 600w,{%- endif -%}
          {%- if image.width >= 800 -%}{{ image | image_url: width: 800, quality: quality }} 800w,{%- endif -%}
          {%- if image.width >= 1000 -%}{{ image | image_url: width: 1000, quality: quality }} 1000w,{%- endif -%}
          {%- if image.width >= 1200 -%}{{ image | image_url: width: 1200, quality: quality }} 1200w,{%- endif -%}
          {%- if image.width >= 1400 -%}{{ image | image_url: width: 1400, quality: quality }} 1400w,{%- endif -%}
          {%- if image.width >= 1600 -%}{{ image | image_url: width: 1600, quality: quality }} 1600w,{%- endif -%}
          {%- if image.width >= 1800 -%}{{ image | image_url: width: 1800, quality: quality }} 1800w,{%- endif -%}
          {%- if image.width >= 2000 -%}{{ image | image_url: width: 2000, quality: quality }} 2000w{%- endif -%}
        "
        src="{{ image | image_url: width: 100, quality: quality }}"
        loading="lazy"
      {%- else -%}
        src="{{ image | image_url: width: 400, quality: quality }}"
        srcset="
          {%- if image.width >= 200 -%}{{ image | image_url: width: 200, quality: quality }} 200w,{%- endif -%}
          {%- if image.width >= 400 -%}{{ image | image_url: width: 400, quality: quality }} 400w,{%- endif -%}
          {%- if image.width >= 600 -%}{{ image | image_url: width: 600, quality: quality }} 600w,{%- endif -%}
          {%- if image.width >= 800 -%}{{ image | image_url: width: 800, quality: quality }} 800w,{%- endif -%}
          {%- if image.width >= 1000 -%}{{ image | image_url: width: 1000, quality: quality }} 1000w,{%- endif -%}
          {%- if image.width >= 1200 -%}{{ image | image_url: width: 1200, quality: quality }} 1200w,{%- endif -%}
          {%- if image.width >= 1400 -%}{{ image | image_url: width: 1400, quality: quality }} 1400w,{%- endif -%}
          {%- if image.width >= 1600 -%}{{ image | image_url: width: 1600, quality: quality }} 1600w,{%- endif -%}
          {%- if image.width >= 1800 -%}{{ image | image_url: width: 1800, quality: quality }} 1800w,{%- endif -%}
          {%- if image.width >= 2000 -%}{{ image | image_url: width: 2000, quality: quality }} 2000w{%- endif -%}
        "
        loading="eager"
      {%- endif -%}
      sizes="{{ sizes | default: 'auto' }}"
      width="{{ image.width }}"
      height="{{ image.height }}"
      alt="{{ image.alt | escape }}"
      fetchpriority="{{ fetchpriority }}"
      decoding="async"
      {%- if format == 'webp' -%}
        data-webp="{{ image | image_url: width: 400, format: 'webp', quality: quality }}"
      {%- endif -%}
      onload="this.classList.add('ultra-image--loaded'); this.parentElement.classList.add('ultra-image-container--loaded')"
      onerror="this.classList.add('ultra-image--error'); this.parentElement.classList.add('ultra-image-container--error')"
    >
  </div>
  
  <style>
    .ultra-image-container {
      position: relative;
      overflow: hidden;
      background: #f5f5f5;
    }
    
    .ultra-image-container--placeholder .ultra-image {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .ultra-image-container--loaded .ultra-image {
      opacity: 1;
    }
    
    .ultra-image-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .ultra-image-skeleton {
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: ultra-skeleton-loading 1.5s infinite;
    }
    
    .ultra-image {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      object-fit: cover;
      will-change: opacity;
    }
    
    .ultra-image--loaded {
      opacity: 1;
    }
    
    .ultra-image--error {
      opacity: 0.5;
    }
    
    @keyframes ultra-skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Performance optimizations */
    .ultra-image-container {
      contain: layout style paint;
    }
    
    .ultra-image {
      will-change: opacity;
    }
  </style>
{%- else -%}
  <div class="ultra-image-container ultra-image-container--placeholder">
    <div class="ultra-image-placeholder">
      <div class="ultra-image-skeleton"></div>
    </div>
  </div>
{%- endif -%}
